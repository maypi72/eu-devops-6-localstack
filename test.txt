#Crear bucket
awslocal s3 mb s3://la-huella-sentiment-reports
awslocal s3 mb s3://la-huella-uploads

#Aplicar política
awslocal s3api put-bucket-policy  --bucket la-huella-uploads --policy file://public-read-policy.json


#TABLAS DYNAMODB
#Tabla 1: la-huella-comments
awslocal dynamodb create-table \
  --table-name la-huella-comments \
  --attribute-definitions \
      AttributeName=id,AttributeType=S \
      AttributeName=productId,AttributeType=S \
      AttributeName=createdAt,AttributeType=S \
  --key-schema AttributeName=id,KeyType=HASH \
  --global-secondary-indexes '[
      {
        "IndexName": "ProductIndex",
        "KeySchema": [
          { "AttributeName": "productId", "KeyType": "HASH" },
          { "AttributeName": "createdAt", "KeyType": "RANGE" }
        ],
        "Projection": { "ProjectionType": "ALL" },
        "ProvisionedThroughput": {
          "ReadCapacityUnits": 5,
          "WriteCapacityUnits": 5
        }
      }
    ]' \
  --provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5

#Tabla 2: la-huella-products
awslocal dynamodb create-table \
  --table-name la-huella-products \
  --attribute-definitions \
      AttributeName=id,AttributeType=S \
      AttributeName=category,AttributeType=S \
  --key-schema AttributeName=id,KeyType=HASH \
  --global-secondary-indexes '[
      {
        "IndexName": "CategoryIndex",
        "KeySchema": [
          { "AttributeName": "category", "KeyType": "HASH" }
        ],
        "Projection": { "ProjectionType": "ALL" },
        "ProvisionedThroughput": {
          "ReadCapacityUnits": 5,
          "WriteCapacityUnits": 5
        }
      }
    ]' \
  --provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5

  #Tabla 3: la-huella-analytics
  awslocal dynamodb create-table \
  --table-name la-huella-analytics \
  --attribute-definitions \
      AttributeName=id,AttributeType=S \
      AttributeName=date,AttributeType=S \
  --key-schema \
      AttributeName=id,KeyType=HASH \
      AttributeName=date,KeyType=RANGE \
  --provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5


#Cola de procesamiento
awslocal sqs create-queue --queue-name la-huella-processing-queue
#Cola de notificaciones
awslocal sqs create-queue --queue-name la-huella-notifications-queue
#Cola Dead Letter Queue (DLQ) — mensajes fallidos
awslocal sqs create-queue --queue-name la-huella-processing-dlq
#Verificar las colas: awslocal sqs list-queues

#Crear **2 grupos de logs**:
awslocal logs create-log-group --log-group-name /la-huella/sentiment-analysis
awslocal logs create-log-group --log-group-name /la-huella/apiawslocal logs create-log-group --log-group-name /la-huella/sentiment-analysis
awslocal logs create-log-group --log-group-name /la-huella/api

awslocal logs create-log-group --log-group-name /la-huella/sentiment-analysis
awslocal logs create-log-group --log-group-name /la-huella/api
#verificar grupos de logs: awslocal logs describe-log-groups

#  EXPORTAR CREDENCIALES DUMMY
export AWS_ACCESS_KEY_ID=test
export AWS_SECRET_ACCESS_KEY=test
export AWS_DEFAULT_REGION=eu-west-1

#NOTAS DEL ACCTION:
# Logs útiles si algo falla
      - name: docker compose ps
        if: always()
        run: docker compose ps

      - name: Localstack container logs (last 200 lines)
        if: failure()
        run: |
          # Ajusta el nombre del servicio si no se llama "localstack"
          CONTAINER_ID=$(docker ps --format '{{.ID}} {{.Names}}' | awk '/localstack/{print $1; exit}')
          if [ -n "$CONTAINER_ID" ]; then
            docker logs --tail 200 "$CONTAINER_ID"
          else
            echo "Localstack container not found by name; check compose service name."
          fi

      - name: Dump docker compose logs to artifact
        if: failure()
        run: |
          mkdir -p artifacts
          docker compose logs --no-color > artifacts/compose.logs.txt || true

      - name: Upload logs artifact
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: localstack-logs
          path: artifacts/compose.logs.txt
